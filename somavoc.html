<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SOMA Vocabulary</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- N3 RDF parser -->
  <script src="https://unpkg.com/n3@1.17.4/browser/n3.min.js"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Lato:wght@400;500&display=swap" rel="stylesheet">
  <link href="style.css" rel="stylesheet" />

  <style>
    #pageTitle{
      color:#e9b02b;
    }
    .table thead th { white-space: nowrap; }
    .id-badge--type {
      display: inline-block;
      background: #e8f5e9;   /* light green */
      color: #1b5e20;        /* dark green text */
      border: 1px solid #c8e6c9;
      padding: .2rem .45rem;
      border-radius: .375rem;
      font-size: .75rem;
      text-decoration: none;
    }

    .id-badge--ext {
      display: inline-block;
      background: #f3e5f5;   /* light violet */
      color: #4a148c;        /* dark violet text */
      border: 1px solid #e1bee7;
      padding: .2rem .45rem;
      border-radius: .375rem;
      font-size: .75rem;
      text-decoration: none;
      margin-right: .25rem;
    }

   
    .sticky-actions {
      position: sticky; top: -1px; background: #fff;
      z-index: 2; padding-top: .25rem; padding-bottom: .25rem;
    }
    #typesTable td { vertical-align: top; }
    #typesTable td:last-child { white-space: pre-wrap; }

    .search-results { position: absolute; z-index: 1000; width: 100%; max-height: 300px; overflow-y: auto; }
    .search-item { cursor: pointer; }
  </style>
</head>
<body class="inner-page">
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg bg-light fixed-top" data-bs-theme="light">
    <div class="container">
      <a class="navbar-brand" href="index.html">S O M A</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
          <li class="nav-item"><a class="nav-link" href="knowledge-graph.html">Knowledge Graph</a></li>
          <li class="nav-item"><a class="nav-link active" href="somavoc.html">Vocabulary</a></li>
          <li class="nav-item"><a class="nav-link" href="documentation.html">Documentation</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="mt-3 ms-3">
    <button id="btnBack" class="btn btn-sm btn-outline-warning back-btn" title="Go back">Back</button>
  </div>


  <div class="container my-4">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h1 id="pageTitle" class="h3 mb-0">Vocabulary</h1>
      <div class="sticky-actions d-flex gap-2">
        <input id="search" class="form-control" placeholder="Filter terms…" style="min-width: 260px" />
        <button class="btn btn-outline-secondary btn-sm" id="btnClear">Clear</button>
      </div>

    </div>

    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle" id="typesTable">
        <thead class="table-light">
          <tr>
            <th style="width: 25%">Term</th>
            <th style="width: 50%">Definition</th>
            <th style="width: 25%">External vocabularies</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
   btnBack.onclick = () => history.back();
(() => {
  const { Parser, Store, DataFactory } = N3;
  const { namedNode } = DataFactory;

  const NS = {
    rdf:  "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
    rdfs: "http://www.w3.org/2000/01/rdf-schema#",
    skos: "http://www.w3.org/2004/02/skos/core#",
    owl:  "http://www.w3.org/2002/07/owl#",
    xsd:  "http://www.w3.org/2001/XMLSchema#"
  };

  const P = {
    type: nn(NS.rdf + 'type'),
    label: nn(NS.rdfs + 'label'),
    definition: nn(NS.skos + 'definition'),
    sameAs: nn(NS.owl + 'sameAs')
  };

  let store = new Store();
  let rows = [];

  function nn(v){ return namedNode(v); }
  function q(s,p,o){ return store.getQuads(s,p,o,null); }
  function isURI(t){ return t && t.termType === 'NamedNode'; }
  function isLiteral(t){ return t && t.termType === 'Literal'; }

  function localFromIri(iriStr){
    if (!iriStr) return '';
    const parts = iriStr.split(/[\/#]/);
    return parts[parts.length-1] || iriStr;
  }

  // Title Case but preserve hyphenated parts (e.g., "Human-Made")
function titleCase(s){
  return s.split(' ').map(w =>
    w.split('-').map(p => p ? p[0].toUpperCase()+p.slice(1).toLowerCase() : p).join('-')
  ).join(' ');
}

// Humanize class/type IRIs (underscores → spaces, Title Case)
function humanizeClass(iriStr){
  if (!iriStr) return '';
  let local = localFromIri(iriStr);

  // If CIDOC (E27_Site → "Site")
  if (iriStr.startsWith(NS.crm) || iriStr.startsWith(NS.crmarchaeo)){
    local = local.replace(/^E\d+_/, ''); // strip E-codes
    local = local.replace(/_/g, ' ');
    return titleCase(local);
  }

  // Generic fallback
  return titleCase(local.replace(/_/g, ' '));
}


  // Prefer @en label if present, else first label, else local name
  function labelOf(node){
    const labs = q(node, P.label, null).map(x => x.object).filter(isLiteral);
    const en = labs.find(l => (l.language || '').toLowerCase() === 'en');
    if (en) return en.value;
    return labs.length ? labs[0].value : localFromIri(node.id);
  }

  // Collect skos:definition literals (any language). Join with newline for display.
  function definitionsOf(node){
    const defs = q(node, P.definition, null).map(x => x.object).filter(isLiteral);
    return defs.map(d => d.value);
  }

  function makeTypeBadge(iriStr){
    const a = document.createElement('a');
    a.href = '#';
    a.className = 'id-badge--type';
    //a.textContent = labelOf(nn(iriStr));
    a.textContent = humanizeClass(iriStr);
    a.title = iriStr; // keep the IRI visible on hover
    a.onclick = (e)=>{ e.preventDefault(); jumpTo(iriStr); };
    return a;
  }

  function sameAsOf(node){
    return q(node, P.sameAs, null).map(x => x.object).filter(isURI);
  }

  function makeExtBadge(iriStr){
    const a = document.createElement('a');
    a.href = iriStr;
    a.target = "_blank";
    a.className = 'id-badge--ext';
    a.textContent = localFromIri(iriStr);
    a.title = iriStr;
    return a;
  }


  function rowIdFromIri(iriStr){
    return 'row-' + encodeURIComponent(iriStr);
  }

  function makeRow(nodeIri){
    const node = nn(nodeIri);
    const tr = document.createElement('tr');
    tr.id = rowIdFromIri(nodeIri);

    // Term cell
    const tdTerm = document.createElement('td');
    const anchor = document.createElement('span');
    anchor.id = localFromIri(nodeIri);
    tdTerm.appendChild(anchor);
    tdTerm.appendChild(makeTypeBadge(nodeIri));

    // Definition cell
    const tdDef = document.createElement('td');
    const defs = definitionsOf(node);
    if (defs.length) {
      for (const d of defs) {
        const p = document.createElement('div');
        p.textContent = d;
        tdDef.appendChild(p);
      }
    }

    // External vocabularies cell
    const tdExt = document.createElement('td');
    const sames = sameAsOf(node);
    if (sames.length) {
      for (const s of sames) {
        tdExt.appendChild(makeExtBadge(s.id));
      }
    }

    tr.appendChild(tdTerm);
    tr.appendChild(tdDef);
    tr.appendChild(tdExt);
    return tr;
  }


  function renderTable(items){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    for (const iri of items){
      tbody.appendChild(makeRow(iri));
    }
  }

  function filterTable(qry){
    const ql = qry.trim().toLowerCase();
    if (!ql){ renderTable(rows); return; }
    const filtered = rows.filter(iri => {
      const node = nn(iri);
      const text = [
        labelOf(node),
        ...definitionsOf(node),
        iri
      ].join(' ').toLowerCase();
      return text.includes(ql);
    });
    renderTable(filtered);
  }

  function jumpTo(iriStr){
    const row = document.getElementById(rowIdFromIri(iriStr));
    if (!row) return;

    // Scroll to row
    row.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Temporarily highlight using Bootstrap's active row style
    row.classList.add('table-active');
    // Update deep-link
    const url = new URL(location.href);
    url.searchParams.set('iri', iriStr);
    url.hash = localFromIri(iriStr);
    history.replaceState(null, '', url.toString());

    // Remove highlight after a few seconds
    setTimeout(() => row.classList.remove('table-active'), 1500);
  }


  async function init(){
    const ttl = await fetch('somavoc.ttl').then(r=>r.text());
    const parser = new Parser({ format:'text/turtle' });
    store = new Store(parser.parse(ttl));

    // all NamedNode subjects defined in somavoc.ttl
    const seen = new Set();
    for (const quad of store.getQuads(null, null, null, null)){
      const s = quad.subject;
      if (isURI(s)) seen.add(s.id);
    }
    rows = Array.from(seen).sort((a,b)=> labelOf(nn(a)).localeCompare(labelOf(nn(b))));
    renderTable(rows);

    // deep-link focus
    const params = new URLSearchParams(location.search);
    const iri = params.get('iri');
    if (iri && seen.has(iri)) {
      setTimeout(()=> jumpTo(iri), 150);
    } else if (location.hash) {
      const frag = location.hash.slice(1);
      const match = rows.find(x => x.endsWith('#'+frag) || x.endsWith('/'+frag));
      if (match) setTimeout(()=> jumpTo(match), 150);
    }
  }

  // Events
  document.getElementById('search').addEventListener('input', (e)=> filterTable(e.target.value));
  document.getElementById('btnClear').addEventListener('click', ()=> {
    const s = document.getElementById('search'); s.value=''; filterTable('');
  });

  init().catch(console.error);
})();
</script>
</body>
</html>
